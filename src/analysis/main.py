"""
main.py

ë©”ì¸ ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸

ì—­í•  ìš”ì•½:
- MHVI í”„ë¡œì íŠ¸ ì „ì²´ ë¶„ì„ íŒŒì´í”„ë¼ì¸ì„ ìˆœì°¨ì ìœ¼ë¡œ ì‹¤í–‰
- ë°ì´í„° ë¡œë“œ â†’ ì •ê·œí™” â†’ ì§€ìˆ˜ ê³„ì‚° â†’ ê²©ì°¨ ë¶„ì„ â†’ ì‹œê°í™” â†’ AI ì§„ë‹¨ â†’ ì •ì±… ì œì•ˆ
  ê¹Œì§€ ëª¨ë“  ë‹¨ê³„ë¥¼ í•œ ë²ˆì— ë¬¶ëŠ” ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„°(Orchestrator)

ì´ íŒŒì¼ í•˜ë‚˜ë§Œ ì‹¤í–‰í•˜ë©´:
â†’ ëª¨ë“  ê²°ê³¼ CSV ìƒì„±
â†’ 4ì‚¬ë¶„ë©´ ì‹œê°í™” ì¶œë ¥
â†’ AI ê¸°ë°˜ ì‚¬ê°ì§€ëŒ€ ë¶„ì„ê¹Œì§€ ì™„ë£Œ
â†’ Need ê¸°ë°˜ ì •ì±… ì œì•ˆ ìƒì„±
â†’ ìì‚´ë¥ -Need ì§€í‘œ ë™ë°˜ì„± ë¶„ì„ ì™„ë£Œ
"""
from config import OUTPUT_DIR
from data_loader import load_data, normalize_data
from need_driver import run_need_driver_analysis
from index_calculator import (
    calculate_need_index,
    calculate_supply_index,
    calculate_gap_index,
    save_rankings
)
from visualization import plot_quadrant_chart
from ai_diagnosis import run_ai_diagnosis
from tree_based_need_analysis import run_tree_based_analysis


def main():
    """
    ë©”ì¸ ë¶„ì„ íŒŒì´í”„ë¼ì¸

    ëª©ì :
    - MHVI í”„ë¡œì íŠ¸ì˜ ëª¨ë“  ë¶„ì„ ë‹¨ê³„ë¥¼
      'ì˜ë¯¸ ìˆëŠ” ìˆœì„œ'ë¡œ ì—°ê²°
    - ê° ë‹¨ê³„ì˜ ì¶œë ¥ì´ ë‹¤ìŒ ë‹¨ê³„ì˜ ì…ë ¥ìœ¼ë¡œ ìì—°ìŠ¤ëŸ½ê²Œ ì´ì–´ì§€ë„ë¡ ì„¤ê³„

    ì „ì²´ íë¦„ ê°œìš”:
    1. ì›ë³¸ ë°ì´í„° ë¡œë“œ ë° ì ê²€
    2. ëª¨ë“  ë³€ìˆ˜ ì •ê·œí™” (0~100)
    3. Need Index ê³„ì‚° (ìœ„í—˜ë„)
    4. Supply Index ê³„ì‚° (ê³µê¸‰ ê²°í•)
    5. Gap Index ê³„ì‚° ë° 4ì‚¬ë¶„ë©´ ë¶„ë¥˜
    6. ì •ì±…/ë³´ê³ ìš© ìˆœìœ„ í…Œì´ë¸” ì €ì¥
    7. ìµœì¢… ê²°ê³¼ CSV ì €ì¥
    8. 4ì‚¬ë¶„ë©´ ì‹œê°í™”
    9. AI ê¸°ë°˜ ì‚¬ê°ì§€ëŒ€ ì§„ë‹¨
    10. Need ê¸°ë°˜ ì •ì±… ì œì•ˆ ìƒì„±
    11. ìì‚´ë¥ -Need ì§€í‘œ ë™ë°˜ì„± ë¶„ì„ (RandomForest + SHAP)
    """

    # =====================================================
    # 1. ë°ì´í„° ë¡œë“œ
    # =====================================================
    # Need / Supply ì›ë³¸ tidy ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ê³ 
    # district ê¸°ì¤€ìœ¼ë¡œ ë³‘í•©ëœ í†µí•© DataFrame ìƒì„±
    df = load_data()

    # =====================================================
    # 2. ë³€ìˆ˜ ì •ê·œí™”
    # =====================================================
    # ì„œë¡œ ë‹¨ìœ„ê°€ ë‹¤ë¥¸ ë³€ìˆ˜ë“¤ì„ 0~100 ì ìˆ˜ë¡œ ë³€í™˜
    # ì´í›„ ê°€ì¤‘í•© ê¸°ë°˜ ì§€ìˆ˜ ê³„ì‚°ì„ ê°€ëŠ¥í•˜ê²Œ í•¨
    df_need_norm, df_supply_norm = normalize_data(df)

    # =====================================================
    # 3. Need Index ê³„ì‚°
    # =====================================================
    # ì •ê·œí™”ëœ Need ë³€ìˆ˜ + ì •ì±…ì  ê°€ì¤‘ì¹˜
    # â†’ ì§€ì—­ë³„ êµ¬ì¡°ì  ì •ì‹ ê±´ê°• ìœ„í—˜ ì§€ìˆ˜ ì‚°ì¶œ
    df_need_norm = calculate_need_index(df_need_norm)

    # =====================================================
    # 4. Supply Index ê³„ì‚°
    # =====================================================
    # ì •ê·œí™”ëœ Supply ë³€ìˆ˜ + ê°€ì¤‘ì¹˜
    # â†’ ì§€ì—­ë³„ ì¸í”„ë¼/ì„œë¹„ìŠ¤ ê²°í• ì§€ìˆ˜ ì‚°ì¶œ
    df_supply_norm = calculate_supply_index(df_supply_norm)

    # =====================================================
    # 5. Gap Index ê³„ì‚° ë° 4ì‚¬ë¶„ë©´ ë¶„ë¥˜
    # =====================================================
    # Gap_Index = Need_Index - Supply_Index
    #
    # ì´ ë‹¨ê³„ì—ì„œ:
    # - ì •ì±… ê°œì… ìš°ì„ ìˆœìœ„ì˜ í•µì‹¬ ì§€í‘œ(Gap_Index) ê³„ì‚°
    # - ì¤‘ì•™ê°’ ê¸°ì¤€ 4ì‚¬ë¶„ë©´(A/B/C/D) ë¶„ë¥˜ ìˆ˜í–‰
    df_final, median_need, median_supply = calculate_gap_index(
        df, df_need_norm, df_supply_norm
    )

    # =====================================================
    # 6. ìˆœìœ„ í…Œì´ë¸” ì €ì¥
    # =====================================================
    # - Need Index ìˆœìœ„
    # - Supply Index ìˆœìœ„
    # - ì§€ì—­ë³„ Need ìƒìœ„ 3ê°œ ìœ„í—˜ ìš”ì¸
    #
    # ì •ì±… ë³´ê³ ì„œ / ëŒ€ì‹œë³´ë“œ / ì§€ë„ ì‹œê°í™”ì—ì„œ
    # ë°”ë¡œ í™œìš© ê°€ëŠ¥í•œ CSV ê²°ê³¼ë¬¼ ìƒì„±
    save_rankings(df, df_need_norm, df_supply_norm)

    # =====================================================
    # 7. ìµœì¢… ê²°ê³¼ í…Œì´ë¸” ì €ì¥
    # =====================================================
    # ëª¨ë“  í•µì‹¬ ê²°ê³¼ë¥¼ í•˜ë‚˜ë¡œ í•©ì¹œ ìµœì¢… í…Œì´ë¸”:
    # district / Need_Index / Supply_Index / Gap_Index / Quadrant
    df_final.to_csv(
        OUTPUT_DIR / "mhvi_final_result.csv",
        index=False,
        encoding="utf-8-sig"
    )

    print("\n" + "=" * 60)
    print("ğŸ’¾ ê²°ê³¼ ì €ì¥ ì™„ë£Œ")
    print("=" * 60)
    print(f"\nì €ì¥ëœ ë³€ìˆ˜:")
    print(f"  - district (êµ¬)")
    print(f"  - Need_Index (ìœ„í—˜ë„)")
    print(f"  - Supply_Index (ì¸í”„ë¼ ê³µê¸‰ë„)")
    print(f"  - Gap_Index (ê²©ì°¨)")
    print(f"  - Quadrant (4ì‚¬ë¶„ë©´ ë¶„ë¥˜)")
    print("\nğŸ‰ ë¶„ì„ ì™„ë£Œ!")
    print("=" * 60)

    # =====================================================
    # 8. 4ì‚¬ë¶„ë©´ ì‹œê°í™”
    # =====================================================
    # Need_Index vs Supply_Index ì‚°ì ë„
    # + ì¤‘ì•™ê°’ ê¸°ì¤€ì„  í‘œì‹œ
    # â†’ ê° ìì¹˜êµ¬ì˜ ì •ì±…ì  ìœ„ì¹˜ë¥¼ ì§ê´€ì ìœ¼ë¡œ í™•ì¸
    plot_quadrant_chart(df_final, median_need, median_supply)

    # =====================================================
    # 9. AI ê¸°ë°˜ ì‚¬ê°ì§€ëŒ€ ë¶„ì„
    # =====================================================
    # "ê³µê¸‰ì´ í‰ê· ì ìœ¼ë¡œ ìœ„í—˜ì„ ì–¼ë§ˆë‚˜ ì™„í™”í•˜ëŠ”ê°€"ë¥¼
    # ì •ìƒ ì‘ë™ ì§€ì—­(A/B)ì—ì„œ í•™ìŠµí•œ ë’¤,
    # ê³µê¸‰ ëŒ€ë¹„ ìœ„í—˜ì´ ê³¼ë„í•œ ì§€ì—­ì„ ì‚¬ê°ì§€ëŒ€ë¡œ ì§„ë‹¨
    df_final, rf_model = run_ai_diagnosis(df, df_final)

    print("\n" + "=" * 60)
    print("âœ… ì „ì²´ íŒŒì´í”„ë¼ì¸ ì™„ë£Œ!")
    print("=" * 60)
    
    # =====================================================
    # 10. Need ê¸°ë°˜ ì •ì±… ì œì•ˆ ìƒì„±
    # =====================================================
    print("\n" + "=" * 60)
    print("ğŸ”¥ ì •ì±… ì œì•ˆ ë‹¨ê³„ ì§„ì…")
    print("=" * 60)

    policy_output_dir = OUTPUT_DIR.parent / "recommend_policy"
    policy_output_dir.mkdir(parents=True, exist_ok=True)

    policy_df = run_need_driver_analysis(df_need_norm)

    policy_df.to_csv(
        policy_output_dir / "need_policy_recommendation_by_district.csv",
        index=False,
        encoding="utf-8-sig"
    )
    
    print("\nğŸ“Œ Need ê¸°ë°˜ ì •ì±… ì œì•ˆ ìƒì„± ì™„ë£Œ")
    print(f"ğŸ“ ì €ì¥ ìœ„ì¹˜: {policy_output_dir}")

    # =====================================================
    # 11. ìì‚´ë¥ -Need ì§€í‘œ ë™ë°˜ì„± ë¶„ì„
    # =====================================================
    print("\n" + "=" * 60)
    print("ğŸŒ² ìì‚´ë¥ -Need ì§€í‘œ ë™ë°˜ì„± ë¶„ì„ (RandomForest + SHAP)")
    print("=" * 60)
    
    # tree_based_need_analysis ì‹¤í–‰
    # ì´ í•¨ìˆ˜ëŠ” ë‚´ë¶€ì—ì„œ ëª¨ë“  ì¶œë ¥ì„ ì²˜ë¦¬í•˜ë¯€ë¡œ ë°˜í™˜ê°’ ì—†ìŒ
    run_tree_based_analysis()
    
    print("\nğŸ“Œ ìì‚´ë¥ -Need ì§€í‘œ ë™ë°˜ì„± ë¶„ì„ ì™„ë£Œ")

    # =====================================================
    # ìµœì¢… ì™„ë£Œ ë©”ì‹œì§€
    # =====================================================
    print("\n" + "=" * 60)
    print("ğŸŠ ëª¨ë“  ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!")
    print("=" * 60)
    print("\nìƒì„±ëœ ê²°ê³¼ë¬¼:")
    print("  1. MHVI ìµœì¢… ê²°ê³¼ (mhvi_final_result.csv)")
    print("  2. 4ì‚¬ë¶„ë©´ ì‹œê°í™”")
    print("  3. AI ì‚¬ê°ì§€ëŒ€ ì§„ë‹¨")
    print("  4. Need ê¸°ë°˜ ì •ì±… ì œì•ˆ")
    print("  5. RandomForest Feature Importance")
    print("  6. SHAP ë¶„ì„ ê²°ê³¼")
    print("  7. ìì‚´ë¥  ì˜ˆì¸¡ ë° ì”ì°¨ ë¶„ì„")
    print("=" * 60 + "\n")


# ì´ íŒŒì¼ì„ ì§ì ‘ ì‹¤í–‰í–ˆì„ ë•Œë§Œ main() ì‹¤í–‰
# (ë‹¤ë¥¸ íŒŒì¼ì—ì„œ importë  ê²½ìš° ìë™ ì‹¤í–‰ ë°©ì§€)
if __name__ == "__main__":
    main()