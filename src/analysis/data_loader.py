"""
data_loader.py

ë°ì´í„° ë¡œë“œ ë° ê¸°ë³¸ ì „ì²˜ë¦¬

ì—­í•  ìš”ì•½:
- Need / Supply ì›ë³¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™€ í•˜ë‚˜ì˜ í…Œì´ë¸”ë¡œ ë³‘í•©
- ì´í›„ ì§€ìˆ˜ ê³„ì‚°ì„ ìœ„í•´ ëª¨ë“  ë³€ìˆ˜ë¥¼ ë™ì¼í•œ ìŠ¤ì¼€ì¼(0~100)ë¡œ ì •ê·œí™”
- "ë°ì´í„°ê°€ ì œëŒ€ë¡œ ë“¤ì–´ì™”ëŠ”ì§€"ë¥¼ ì‚¬ëŒì´ í™•ì¸í•  ìˆ˜ ìˆë„ë¡
  í’ë¶€í•œ ë¡œê·¸ ì¶œë ¥ ì œê³µ
"""
import pandas as pd
from sklearn.preprocessing import MinMaxScaler
from config import DATA_DIR, NEED_VARS, SUPPLY_VARS


def load_data():
    """
    Needì™€ Supply ë°ì´í„° ë¡œë“œ ë° ë³‘í•©

    ëª©ì :
    - ì„œë¡œ ë‹¤ë¥¸ íŒŒì¼ë¡œ ê´€ë¦¬ë˜ëŠ” Need / Supply ë°ì´í„°ë¥¼
      'district'ë¥¼ ê¸°ì¤€ìœ¼ë¡œ í•˜ë‚˜ì˜ ë¶„ì„ í…Œì´ë¸”ë¡œ í†µí•©
    - ì´í›„ ëª¨ë“  ë¶„ì„ì˜ ì…ë ¥ ë°ì´í„°ê°€ ë˜ëŠ” ê¸°ë³¸ df ìƒì„±

    ì „ì œ:
    - need_tidy.csvì™€ supply_tidy.csvëŠ”
      ì´ë¯¸ 'district ë‹¨ìœ„ë¡œ ì§‘ê³„ëœ tidy ë°ì´í„°'
    - ë‘ íŒŒì¼ ëª¨ë‘ district ì»¬ëŸ¼ì„ ê³µí†µ í‚¤ë¡œ ê°€ì§„ë‹¤

    ë°˜í™˜:
    - df: district + Need ë³€ìˆ˜ + Supply ë³€ìˆ˜ê°€ ëª¨ë‘ í¬í•¨ëœ DataFrame
    """

    # -----------------------------------------------------
    # 1. ì „ì²˜ë¦¬ ì™„ë£Œëœ Need / Supply ë°ì´í„° ë¡œë“œ
    # -----------------------------------------------------
    # DATA_DIRì€ config.pyì—ì„œ ì •ì˜ëœ processed ë°ì´í„° ê²½ë¡œ
    df_need = pd.read_csv(DATA_DIR / "need_tidy.csv")
    df_supply = pd.read_csv(DATA_DIR / "supply_tidy.csv")

    # -----------------------------------------------------
    # 2. district ê¸°ì¤€ inner join
    # -----------------------------------------------------
    # inner joinì„ ì‚¬ìš©í•˜ëŠ” ì´ìœ :
    # - Needì™€ Supply ë°ì´í„°ê°€ ëª¨ë‘ ì¡´ì¬í•˜ëŠ” ìì¹˜êµ¬ë§Œ ë¶„ì„ ëŒ€ìƒìœ¼ë¡œ ì‚¼ê¸° ìœ„í•¨
    # - í•œìª½ ë°ì´í„°ê°€ ì—†ëŠ” ì§€ì—­ì„ ì–µì§€ë¡œ í¬í•¨ì‹œí‚¤ë©´
    #   ì´í›„ ì§€ìˆ˜ ê³„ì‚° ë° AI ë¶„ì„ì—ì„œ ì™œê³¡ ë°œìƒ ê°€ëŠ¥
    df = df_need.merge(df_supply, on='district', how='inner')

    # -----------------------------------------------------
    # 3. ë°ì´í„° ë¡œë“œ ê²°ê³¼ ì ê²€ìš© ë¡œê·¸ ì¶œë ¥
    # -----------------------------------------------------
    print("=" * 60)
    print("ğŸ“Š ë°ì´í„° ë¡œë“œ ì™„ë£Œ")
    print("=" * 60)
    print(f"Shape: {df.shape}")                  # (í–‰, ì—´) í¬ê¸°
    print(f"êµ¬ ê°œìˆ˜: {len(df)}")                 # ìì¹˜êµ¬ ìˆ˜ (ë³´í†µ 25)
    print(f"ë³€ìˆ˜ ê°œìˆ˜: {len(df.columns) - 1}")   # district ì œì™¸ ë³€ìˆ˜ ìˆ˜

    print("\në³€ìˆ˜ ëª©ë¡:")
    # df_need.columns[1:] â†’ districtë¥¼ ì œì™¸í•œ Need ë³€ìˆ˜ë“¤
    print("Need (11ê°œ):", df_need.columns.tolist()[1:])
    print("Supply (9ê°œ):", df_supply.columns.tolist()[1:])

    print("\nì²« 5ê°œ êµ¬:")
    print(df.head())

    print("\nê¸°ì´ˆ í†µê³„:")
    # ê° ë³€ìˆ˜ì˜ min/max/mean/std ë“± ë¶„í¬ í™•ì¸
    print(df.describe())

    print("\nê²°ì¸¡ì¹˜ í™•ì¸:")
    # ì „ì²´ ê²°ì¸¡ì¹˜ ê°œìˆ˜ í•©ê³„
    # â†’ 0ì´ ì•„ë‹ˆë©´ ì´í›„ ë¶„ì„ ì „ ë°˜ë“œì‹œ ì ê²€ í•„ìš”
    print(df.isnull().sum().sum())

    print("\nâœ… ë°ì´í„° ì¤€ë¹„ ì™„ë£Œ!")

    return df


def normalize_to_100(series):
    """
    0~100ì ìœ¼ë¡œ ì •ê·œí™”

    ëª©ì :
    - ì„œë¡œ ë‹¨ìœ„ê°€ ë‹¤ë¥¸ ë³€ìˆ˜ë“¤(ë¹„ìœ¨, ê°œìˆ˜, ê¸ˆì•¡ ë“±)ì„
      ë™ì¼í•œ ìŠ¤ì¼€ì¼ë¡œ ë³€í™˜í•˜ì—¬
      ê°€ì¤‘í•©(Need_Index, Supply_Index)ì´ ê°€ëŠ¥í•˜ë„ë¡ í•¨

    ë°©ë²•:
    - Min-Max Scaling ì‚¬ìš©
    - ìµœì†Ÿê°’ â†’ 0, ìµœëŒ“ê°’ â†’ 100
    - ì¤‘ê°„ ê°’ì€ ì„ í˜• ë¹„ë¡€

    Parameters:
    -----------
    series : pd.Series
        ì •ê·œí™”í•  ë‹¨ì¼ ë³€ìˆ˜ ì‹œë¦¬ì¦ˆ

    Returns:
    --------
    np.array
        0~100 ë²”ìœ„ë¡œ ì •ê·œí™”ëœ ê°’ (1ì°¨ì› ë°°ì—´)

    âš ï¸ ì£¼ì˜:
    - ì´ í•¨ìˆ˜ëŠ” ë°©í–¥ì„±(ì¢‹ë‹¤/ë‚˜ì˜ë‹¤)ì„ ê³ ë ¤í•˜ì§€ ì•ŠìŒ
    - ì¦‰, "ê°’ì´ í´ìˆ˜ë¡ ë‚˜ìœ ë³€ìˆ˜"ë“  "í´ìˆ˜ë¡ ì¢‹ì€ ë³€ìˆ˜"ë“ 
      ì¼ë‹¨ í¬ê¸°ë§Œ ê¸°ì¤€ìœ¼ë¡œ 0~100ìœ¼ë¡œ ë³€í™˜
    - ë°©í–¥ì„± ì²˜ë¦¬ëŠ” ì´í›„ ì§€ìˆ˜ í•´ì„ ë‹¨ê³„ì—ì„œ ì˜ë¯¸ë¥¼ ë¶€ì—¬
    """
    scaler = MinMaxScaler(feature_range=(0, 100))
    normalized = scaler.fit_transform(series.values.reshape(-1, 1))
    return normalized.flatten()


def normalize_data(df):
    """
    Needì™€ Supply ë³€ìˆ˜ ì •ê·œí™”

    ëª©ì :
    - load_data()ë¡œ ë¶ˆëŸ¬ì˜¨ í†µí•© dfë¥¼ ì…ë ¥ìœ¼ë¡œ ë°›ì•„
      Need / Supply ë³€ìˆ˜ë¥¼ ê°ê° 0~100 ìŠ¤ì¼€ì¼ë¡œ ë³€í™˜
    - ì´í›„ ê°€ì¤‘ì¹˜(WEIGHTS_NEED, WEIGHTS_SUPPLY)ë¥¼ ê³±í•´
      ì§€ìˆ˜ ê³„ì‚°ì— ì‚¬ìš©í•˜ê¸° ìœ„í•œ ì¤‘ê°„ ê²°ê³¼ ìƒì„±

    ì…ë ¥:
    - df: district + Need + Supply ë³€ìˆ˜ë¥¼ í¬í•¨í•œ DataFrame

    ì¶œë ¥:
    - df_need_norm:
        district + ê° Need ë³€ìˆ˜ì˜ *_norm ì»¬ëŸ¼
    - df_supply_norm:
        district + ê° Supply ë³€ìˆ˜ì˜ *_norm ì»¬ëŸ¼
    """

    print("=" * 60)
    print("ğŸ“ ë³€ìˆ˜ ì •ê·œí™”")
    print("=" * 60)

    # -----------------------------------------------------
    # 1. Need ë³€ìˆ˜ ì •ê·œí™”
    # -----------------------------------------------------
    # district ì»¬ëŸ¼ì€ ê·¸ëŒ€ë¡œ ë‘ê³ ,
    # ê° Need ë³€ìˆ˜ë¥¼ normalize_to_100ìœ¼ë¡œ ë³€í™˜
    df_need_norm = df[['district']].copy()
    for var in NEED_VARS:
        df_need_norm[f'{var}_norm'] = normalize_to_100(df[var])
        print(f"  âœ… {var:40s} â†’ ì •ê·œí™” ì™„ë£Œ")

    # -----------------------------------------------------
    # 2. Supply ë³€ìˆ˜ ì •ê·œí™”
    # -----------------------------------------------------
    # Supply ë³€ìˆ˜ë„ ë™ì¼í•œ ë°©ì‹ìœ¼ë¡œ 0~100 ìŠ¤ì¼€ì¼ ë³€í™˜
    df_supply_norm = df[['district']].copy()
    for var in SUPPLY_VARS:
        df_supply_norm[f'{var}_norm'] = normalize_to_100(df[var])
        print(f"  âœ… {var:40s} â†’ ì •ê·œí™” ì™„ë£Œ")

    # -----------------------------------------------------
    # 3. ì •ê·œí™” ê²°ê³¼ ìƒ˜í”Œ ì¶œë ¥
    # -----------------------------------------------------
    # ì‚¬ëŒì´ ì§ì ‘ í™•ì¸í•˜ë©´ì„œ
    # - ê°’ ë²”ìœ„ê°€ 0~100ì¸ì§€
    # - ì´ìƒì¹˜ê°€ íŠ€ì§€ ì•Šì•˜ëŠ”ì§€
    # ë¹ ë¥´ê²Œ ì ê²€í•˜ê¸° ìœ„í•œ ì¶œë ¥
    print("\nì •ê·œí™” ê²°ê³¼ ìƒ˜í”Œ:")
    print(df_need_norm.head())

    print("\nâœ… ëª¨ë“  ë³€ìˆ˜ 0~100ì  ë³€í™˜ ì™„ë£Œ")

    return df_need_norm, df_supply_norm
