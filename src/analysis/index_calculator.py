"""
index_calculator.py

Need, Supply, Gap Index ê³„ì‚°

ì—­í•  ìš”ì•½:
- ì •ê·œí™”ëœ Need / Supply ë³€ìˆ˜ë“¤ì„ ê°€ì¤‘í•©í•˜ì—¬
  ê°ê° Need_Index, Supply_Indexë¥¼ ê³„ì‚°
- ë‘ ì§€ìˆ˜ì˜ ì°¨ì´ë¥¼ í†µí•´ Gap_Indexë¥¼ ì •ì˜
- Gap_Index ë° Need/Supply ë¶„í¬ë¥¼ ê¸°ë°˜ìœ¼ë¡œ 4ì‚¬ë¶„ë©´ ë¶„ë¥˜ ìˆ˜í–‰
- ì •ì±… ë³´ê³  ë° ì‹œê°í™”ë¥¼ ìœ„í•œ ìˆœìœ„ í…Œì´ë¸” ì €ìž¥

ì´ íŒŒì¼ì€:
'ë°ì´í„° â†’ ì˜ë¯¸ ìžˆëŠ” ì§€ìˆ˜ â†’ ì •ì±…ì  í•´ì„ ë‹¨ìœ„'
ë¡œ ë³€í™˜í•˜ëŠ” í•µì‹¬ ë‹¨ê³„ë‹¤.
"""
import pandas as pd
from config import WEIGHTS_NEED, WEIGHTS_SUPPLY, OUTPUT_DIR


def calculate_need_index(df_need_norm):
    """

    Need Index ê³„ì‚°

    MHVI â€“ Need Index ìˆœìœ„

    ëª©ì :
    - ê° ì§€ì—­ì˜ êµ¬ì¡°ì  ì •ì‹ ê±´ê°• ìœ„í—˜ ìˆ˜ì¤€ì„ í•˜ë‚˜ì˜ ì§€ìˆ˜ë¡œ ìš”ì•½
    - ê°œë³„ ìœ„í—˜ ì§€í‘œë“¤ì„ ë‹¨ìˆœ ë‚˜ì—´ì´ ì•„ë‹ˆë¼,
      'ì •ì±…ì ìœ¼ë¡œ ì¤‘ìš”í•˜ë‹¤ê³  íŒë‹¨í•œ ë¹„ì¤‘'ì— ë”°ë¼ í†µí•©

    ê³„ì‚°ì‹:
    Need_Index = Î£ (ì •ê·œí™”ëœ Need ë³€ìˆ˜ Ã— í•´ë‹¹ ê°€ì¤‘ì¹˜)

    í•´ì„:
    - Need_Indexê°€ ë†’ì„ìˆ˜ë¡:
        â†’ ì •ì‹ ê±´ê°• ì·¨ì•½ë„ê°€ ë†’ê³ 
        â†’ êµ¬ì¡°ì  ìœ„í—˜ì´ ëˆ„ì ë˜ì–´ ìžˆìœ¼ë©°
        â†’ ì •ì±… ê°œìž…ì˜ í•„ìš”ì„±ì´ í¼
    - 0~100 ìŠ¤ì¼€ì¼ì—ì„œ ìƒëŒ€ì  ë¹„êµ ì§€í‘œ

    ìˆœìœ„:
    - 1ìœ„ = ê°€ìž¥ ì·¨ì•½í•œ ì§€ì—­
    """

    # -----------------------------------------------------
    # 1. Need_Index ì´ˆê¸°í™”
    # -----------------------------------------------------
    # ê¸°ì¡´ df_need_normì—ëŠ” *_norm ì»¬ëŸ¼ë“¤ë§Œ ì¡´ìž¬
    # ì—¬ê¸°ì— ìƒˆë¡œìš´ ì§‘ê³„ ì§€í‘œì¸ Need_Indexë¥¼ ì¶”ê°€
    df_need_norm['Need_Index'] = 0

    # -----------------------------------------------------
    # 2. ê°€ì¤‘í•© ê³„ì‚°
    # -----------------------------------------------------
    # WEIGHTS_NEED:
    #   key   â†’ ì •ê·œí™”ëœ ë³€ìˆ˜ëª… (ì˜ˆ: suicide_rate_norm)
    #   value â†’ í•´ë‹¹ ë³€ìˆ˜ì˜ ì •ì±…ì  ì¤‘ìš”ë„ ê°€ì¤‘ì¹˜
    #
    # ëª¨ë“  ê°€ì¤‘ì¹˜ì˜ í•©ì€ 1 â†’ ì§€ìˆ˜ í•´ì„ì´ ì§ê´€ì 
    for var, weight in WEIGHTS_NEED.items():
        df_need_norm['Need_Index'] += df_need_norm[var] * weight

    # -----------------------------------------------------
    # 3. ì •ë ¬ (ì¶œë ¥/í™•ì¸ìš©)
    # -----------------------------------------------------
    # ì‹¤ì œ ë°˜í™˜ê°’ì—ëŠ” ì •ë ¬ì„ ê°•ì œí•˜ì§€ ì•Šì§€ë§Œ,
    # ìƒìœ„ ìœ„í—˜ ì§€ì—­ì„ ë¹ ë¥´ê²Œ í™•ì¸í•˜ê¸° ìœ„í•œ ìš©ë„
    df_sorted = df_need_norm.sort_values('Need_Index', ascending=False)

    print("\nâœ… Need Index ê³„ì‚° ì™„ë£Œ")

    # Need_Indexê°€ ì¶”ê°€ëœ DataFrame ë°˜í™˜
    return df_need_norm


def calculate_supply_index(df_supply_norm):
    """

    Supply Index ê³„ì‚°

    MHVI â€“ ê³µê¸‰ ê²°í•(Supply Deficit) ì§€ìˆ˜ ìˆœìœ„

    ëª©ì :
    - ì§€ì—­ë³„ ì •ì‹ ê±´ê°• ì¸í”„ë¼ ë° ì„œë¹„ìŠ¤ì˜ 'ë¶€ì¡± ì •ë„'ë¥¼ í•˜ë‚˜ì˜ ì§€ìˆ˜ë¡œ ìš”ì•½
    - ë‹¨ìˆœí•œ ì¸í”„ë¼ ë‚˜ì—´ì´ ì•„ë‹ˆë¼,
      ì •ì±…ì ìœ¼ë¡œ ì¤‘ìš”í•˜ë‹¤ê³  íŒë‹¨í•œ ì¸í”„ë¼ì— ë” í° ë¹„ì¤‘ ë¶€ì—¬

    ê³„ì‚°ì‹:
    Supply_Index = Î£ (ì •ê·œí™”ëœ Supply ë³€ìˆ˜ Ã— í•´ë‹¹ ê°€ì¤‘ì¹˜)

    í•´ì„:
    - Supply_Indexê°€ ë†’ì„ìˆ˜ë¡:
        â†’ í•´ë‹¹ ì§€ì—­ì˜ ì§€ì› ì²´ê³„ê°€ ìƒëŒ€ì ìœ¼ë¡œ ë¶€ì¡±í•¨
        â†’ ë™ì¼í•œ ìœ„í—˜ ìˆ˜ì¤€ì´ë¼ë©´ ë” ì·¨ì•½í•œ ìƒíƒœ
    - 'ê³µê¸‰ì´ ë§Žë‹¤/ì ë‹¤'ê°€ ì•„ë‹ˆë¼
      'ê³µê¸‰ ê²°í•ì˜ ìƒëŒ€ì  ì •ë„'ë¥¼ í‘œí˜„í•˜ëŠ” ì§€í‘œ

    ìˆœìœ„:
    - 1ìœ„ = ê°€ìž¥ ì§€ì›ì´ ë¶€ì¡±í•œ ì§€ì—­
    """

    print("\n" + "=" * 60)
    print("ðŸ¥ Supply Index ê³„ì‚°")
    print("=" * 60)

    # -----------------------------------------------------
    # 1. Supply_Index ì´ˆê¸°í™”
    # -----------------------------------------------------
    df_supply_norm['Supply_Index'] = 0

    # -----------------------------------------------------
    # 2. ê°€ì¤‘í•© ê³„ì‚°
    # -----------------------------------------------------
    # WEIGHTS_SUPPLYì— ì •ì˜ëœ ê°€ì¤‘ì¹˜ì— ë”°ë¼
    # ì˜ë£Œ/ë³´ê±´/ë…¸ì¸/ë¬¸í™” ì¸í”„ë¼ë¥¼ ì¢…í•©ì ìœ¼ë¡œ ë°˜ì˜
    for var, weight in WEIGHTS_SUPPLY.items():
        df_supply_norm['Supply_Index'] += df_supply_norm[var] * weight

    # -----------------------------------------------------
    # 3. ì •ë ¬ (í™•ì¸ìš©)
    # -----------------------------------------------------
    df_sorted = df_supply_norm.sort_values('Supply_Index', ascending=False)

    print("\nâœ… Supply Index ê³„ì‚° ì™„ë£Œ")

    return df_supply_norm


def calculate_gap_index(df, df_need_norm, df_supply_norm):
    """
    Gap Index ê³„ì‚° ë° 4ì‚¬ë¶„ë©´ ë¶„ë¥˜

    ëª©ì :
    - 'ìœ„í—˜(Need)'ê³¼ 'ì§€ì› ë¶€ì¡±(Supply)'ì„ ë™ì‹œì— ê³ ë ¤í•˜ì—¬
      ì •ì±… ê°œìž… ìš°ì„ ìˆœìœ„ë¥¼ ë„ì¶œ
    - ë‹¨ì¼ ì§€ìˆ˜ë¡œ ë³´ê¸° ì–´ë ¤ìš´ ë‘ ì¶•ì„
      Gap_Indexì™€ 4ì‚¬ë¶„ë©´ êµ¬ì¡°ë¡œ í•´ì„ ê°€ëŠ¥í•˜ê²Œ ë§Œë“¦

    ì •ì˜:
    Gap_Index = Need_Index - Supply_Index

    ì˜ë¯¸:
    - Need_Index   : í•´ë‹¹ ì§€ì—­ì˜ ì •ì‹ ê±´ê°• ìœ„í—˜ ìˆ˜ì¤€
    - Supply_Index : í•´ë‹¹ ì§€ì—­ì˜ ì§€ì› ê²°í• ìˆ˜ì¤€
    - Gap_Index    : ìœ„í—˜ ëŒ€ë¹„ ë°©ì¹˜ ì •ë„
        â€¢ ê°’ì´ í´ìˆ˜ë¡:
            â†’ ìœ„í—˜ì€ í°ë°
            â†’ ì§€ì›ì€ ë¶€ì¡±í•œ ì§€ì—­
            â†’ ì •ì±… ê°œìž…ì´ ì‹œê¸‰
    """

    print("\n" + "=" * 60)
    print("ðŸŽ¯ Gap Index ê³„ì‚° (Need - Supply)")
    print("=" * 60)

    # -----------------------------------------------------
    # 1. Need / Supply ì§€ìˆ˜ í†µí•©
    # -----------------------------------------------------
    # districtë¥¼ ê¸°ì¤€ìœ¼ë¡œ
    # Need_Indexì™€ Supply_Indexë¥¼ í•˜ë‚˜ì˜ í…Œì´ë¸”ë¡œ ê²°í•©
    df_final = df[['district']].copy()
    df_final = df_final.merge(
        df_need_norm[['district', 'Need_Index']],
        on='district'
    )
    df_final = df_final.merge(
        df_supply_norm[['district', 'Supply_Index']],
        on='district'
    )

    # -----------------------------------------------------
    # 2. Gap_Index ê³„ì‚°
    # -----------------------------------------------------
    df_final['Gap_Index'] = (
        df_final['Need_Index'] - df_final['Supply_Index']
    )

    # -----------------------------------------------------
    # 3. Gap ê¸°ì¤€ ì •ë ¬ (í™•ì¸ìš©)
    # -----------------------------------------------------
    df_sorted = df_final.sort_values('Gap_Index', ascending=False)

    # -----------------------------------------------------
    # 4. 4ì‚¬ë¶„ë©´ ë¶„ë¥˜
    # -----------------------------------------------------
    # ì¤‘ì•™ê°’(median)ì„ ê¸°ì¤€ìœ¼ë¡œ High / Low êµ¬ë¶„
    # â†’ ì†Œí‘œë³¸ì—ì„œ í‰ê· ë³´ë‹¤ ì•ˆì •ì ì¸ ê¸°ì¤€
    median_need = df_final['Need_Index'].median()
    median_supply = df_final['Supply_Index'].median()

    # 4ì‚¬ë¶„ë©´ ë¶„ë¥˜ ê·œì¹™:
    # C: Need ë†’ìŒ & Supply ë¶€ì¡± â†’ ê°€ìž¥ ì‹œê¸‰í•œ ê°œìž… ëŒ€ìƒ
    # D: Need ë†’ìŒ & Supply ë†’ìŒ â†’ ëŒ€ì‘ ì¤‘ì´ë‚˜ ìœ„í—˜ ì§€ì†
    # B: Need ë‚®ìŒ & Supply ë¶€ì¡± â†’ ìž ìž¬ ìœ„í—˜êµ°
    # A: Need ë‚®ìŒ & Supply ì¶©ë¶„ â†’ ë¹„êµì  ì•ˆì •
    def classify_quadrant(row):
        if row['Need_Index'] >= median_need and row['Supply_Index'] < median_supply:
            return 'C'
        elif row['Need_Index'] >= median_need and row['Supply_Index'] >= median_supply:
            return 'D'
        elif row['Need_Index'] < median_need and row['Supply_Index'] < median_supply:
            return 'B'
        else:
            return 'A'

    df_final['Quadrant'] = df_final.apply(
        classify_quadrant,
        axis=1
    )

    print("\nðŸ“Š 4ì‚¬ë¶„ë©´ ë¶„ë¥˜:")
    print(df_final['Quadrant'].value_counts())
    print("\nâœ… Gap Index ë° ë¶„ë¥˜ ì™„ë£Œ")

    return df_final, median_need, median_supply


def save_rankings(df, df_need_norm, df_supply_norm):
    """
    ìˆœìœ„ í…Œì´ë¸” ì €ìž¥ í•¨ìˆ˜

    ìƒì„± íŒŒì¼:
    1) Need Index ìˆœìœ„
    2) Supply Index ìˆœìœ„
    3) ì§€ì—­ë³„ Need ìƒìœ„ 3ê°œ ìœ„í—˜ ìš”ì¸

    ëª©ì :
    - ì •ì±… ë³´ê³ ì„œ, ëŒ€ì‹œë³´ë“œ, ì§€ë„ ì‹œê°í™”ì— ë°”ë¡œ ì‚¬ìš©í•  ìˆ˜ ìžˆëŠ”
      'ì •ë¦¬ëœ ê²°ê³¼ í…Œì´ë¸”' ìƒì„±
    """
    from config import NEED_VARS, OUTPUT_DIR
    import pandas as pd

    # =========================
    # 1. Need Index ìˆœìœ„
    # =========================
    # Need_Indexê°€ ë†’ì€ ì§€ì—­ë¶€í„° ìˆœìœ„ ë¶€ì—¬
    need_rank_df = (
        df_need_norm[['district', 'Need_Index']]
        .sort_values('Need_Index', ascending=False)
        .reset_index(drop=True)
    )
    need_rank_df['rank'] = need_rank_df.index + 1

    need_rank_df.to_csv(
        OUTPUT_DIR / "need_index_ranking.csv",
        index=False,
        encoding="utf-8-sig"
    )

    # =========================
    # 2. Supply Index ìˆœìœ„
    # =========================
    # Supply_Indexê°€ ë†’ì€ ì§€ì—­ = ì§€ì›ì´ ë” ë¶€ì¡±í•œ ì§€ì—­
    supply_rank_df = (
        df_supply_norm[['district', 'Supply_Index']]
        .sort_values('Supply_Index', ascending=False)
        .reset_index(drop=True)
    )
    supply_rank_df['rank'] = supply_rank_df.index + 1

    supply_rank_df.to_csv(
        OUTPUT_DIR / "supply_index_ranking.csv",
        index=False,
        encoding="utf-8-sig"
    )

    # =========================
    # 3. ì§€ì—­ë³„ NEED ìƒìœ„ 3ê°œ ì§€í‘œ
    # =========================
    """
    MHVI â€“ ì§€ì—­ë³„ ì£¼ìš” ìœ„í—˜ ìš”ì¸ ìƒìœ„ 3ê°œ

    ëª©ì :
    - ê° ì§€ì—­ì˜ Need_Indexë¥¼ êµ¬ì„±í•˜ëŠ” í•µì‹¬ ìœ„í—˜ ìš”ì¸ì„ ì‹ë³„
    - "ì™œ ì´ ì§€ì—­ì˜ Needê°€ ë†’ì€ê°€?"ì— ëŒ€í•œ ì„¤ëª… ê°€ëŠ¥ì„± í™•ë³´

    ì»¬ëŸ¼ ì„¤ëª…:
    - district      : ìžì¹˜êµ¬
    - rank          : í•´ë‹¹ ì§€ì—­ ë‚´ ìœ„í—˜ ìš”ì¸ ìˆœìœ„
    - need_variable : ìœ„í—˜ ì§€í‘œ ì´ë¦„ (ì •ê·œí™” ì´ì „ ë³€ìˆ˜ëª…)
    - score         : ì •ê·œí™” ì ìˆ˜ (0~100, ë†’ì„ìˆ˜ë¡ ì‹¬ê°)
    """

    rows = []
    for _, row in df_need_norm.iterrows():
        district = row['district']

        # Need_Indexë¥¼ êµ¬ì„±í•˜ëŠ” ê°œë³„ ì •ê·œí™” ë³€ìˆ˜ ì ìˆ˜ ì¶”ì¶œ
        scores = {
            var.replace('_norm', ''): row[var]
            for var in df_need_norm.columns
            if var.endswith('_norm') and var != 'Need_Index'
        }

        # ì ìˆ˜ê°€ ë†’ì€ ìˆœìœ¼ë¡œ ìƒìœ„ 3ê°œ ì„ íƒ
        top3 = sorted(
            scores.items(),
            key=lambda x: x[1],
            reverse=True
        )[:3]

        # ì§€ì—­ Ã— ìˆœìœ„ Ã— ë³€ìˆ˜ í˜•íƒœë¡œ í–‰ êµ¬ì„±
        for rank, (var, score) in enumerate(top3, start=1):
            rows.append({
                'district': district,
                'rank': rank,
                'need_variable': var,
                'score': score
            })

    need_top3_df = pd.DataFrame(rows)
    need_top3_df.to_csv(
        OUTPUT_DIR / "district_need_top3.csv",
        index=False,
        encoding="utf-8-sig"
    )

    print("ðŸ“Š ìˆœìœ„ í…Œì´ë¸” ì €ìž¥ ì™„ë£Œ")
